<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Media Collection</title>
  <style>
    :root{ --bg:#0f0f10; --card-bg:#111; --gap:20px; --radius:12px; }
    *{box-sizing:border-box}
    body { font-family: Arial, sans-serif; background: var(--bg); color: #fff; margin: 0; padding: 0; -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale; }
    .content-wrapper { padding: 20px; }
    h1 { text-align: center; margin: 0 0 24px 0; font-weight:600; }
    .masonry-wrapper { column-count: 4; column-gap: var(--gap); }
    .media-card { background: var(--card-bg); border-radius: var(--radius); overflow: hidden; display: block; cursor: pointer; position: relative; transition: transform 0.2s ease; break-inside: avoid; margin-bottom: var(--gap); min-height:120px; text-decoration: none;}
    .media-card:hover { transform: translateY(-2px); }
    /* Ensure images cover the area */
    .media-card img, .media-card video { display:block; width:100%; height:auto; vertical-align: middle; border: 0; background: #222; }
    
    .media-card .placeholder { padding: 48px 12px; text-align:center; color:#999; font-size:14px; }
    
    /* Play icon overlay for video thumbnails */
    .video-overlay { position: absolute; inset: 0; display: flex; align-items: center; justify-content: center; background: rgba(0,0,0,0.3); transition: background 0.2s; }
    .video-overlay:hover { background: rgba(0,0,0,0.1); }
    .play-icon { font-size: 40px; color: rgba(255,255,255,0.9); text-shadow: 0 2px 10px rgba(0,0,0,0.5); }

    .media-card video{ filter:brightness(.95); }
    #lightbox{ position:fixed; inset:0; display:none; align-items:center; justify-content:center; background: rgba(0,0,0,0.95); z-index:9999; padding:10px; }
    #lightbox.active{ display:flex; }
    .lightbox-inner{ max-width:100%; max-height:100%; width:100%; height:100%; display:flex; align-items:center; justify-content:center; flex-direction: column; }
    .lightbox-inner img, .lightbox-inner video{ max-width:100vw; max-height:100vh; width:100%; height:100%; object-fit:contain; border-radius:0; box-shadow:none; }
    .lb-close{ position:fixed; top:18px; right:18px; z-index:10000; background:rgba(255,255,255,0.1); color:#fff; border:0; padding:8px 12px; border-radius:8px; cursor:pointer; font-size:16px; }
    .offline-banner { text-align:center; padding: 10px; background: #880000; color: #fff; font-weight:600; display:none; }
    .password-overlay { position:fixed; inset:0; display:flex; align-items:center; justify-content:center; background: rgba(0,0,0,0.8); z-index:10001; }
    .password-box { background: #0b0b0d; padding:20px; border-radius:12px; min-width:280px; box-shadow: 0 6px 30px rgba(0,0,0,0.6); }
    .password-box input { width:100%; padding:10px; border-radius:8px; border:1px solid #222; background:#111; color:#fff; margin-bottom:8px; }
    .password-box button { width:100%; padding:10px; border-radius:8px; border:0; background:#1e90ff; color:#fff; cursor:pointer; }
    
    .loader { border: 4px solid #333; border-top: 4px solid #fff; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin-bottom: 15px; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

    @media (max-width: 1200px) { .masonry-wrapper { column-count: 3; } }
    @media (max-width: 800px) { .masonry-wrapper { column-count: 2; } }
    @media (max-width: 500px) { .masonry-wrapper { column-count: 1; :root{ --gap:12px } } }
  </style>
</head>
<body>
  <div class="offline-banner" id="offlineBanner">Backend is offline — media unavailable</div>

  <div class="content-wrapper">
    <h1>Media Collection</h1>
    <div class="masonry-wrapper" id="container" aria-live="polite"></div>
  </div>

  <div id="lightbox" role="dialog" aria-hidden="true">
    <button class="lb-close" id="lbClose" aria-label="Close (Esc)">✕</button>
    <div class="lightbox-inner" id="lightboxInner"></div>
  </div>

  <div class="password-overlay" id="passwordOverlay" style="display:none;">
    <div class="password-box">
      <div style="margin-bottom:10px;color:#ddd">Enter password</div>
      <input id="pwInput" type="password" autocomplete="off" placeholder="Password..."/>
      <button id="pwBtn">Unlock</button>
      <div id="pwMsg" style="margin-top:8px;color:#f88;display:none"></div>
    </div>
  </div>

  <script>
  // CONFIG
  const BACKEND_ORIGIN = "https://api.stragi.gay"; 
  const HEALTH_URL = BACKEND_ORIGIN + "/health";
  const AUTH_URL = BACKEND_ORIGIN + "/auth";
  const MEDIA_LIST_URL = BACKEND_ORIGIN + "/media-list";
  const MEDIA_URL_BASE = BACKEND_ORIGIN + "/media/"; 
  const V_THUMB_URL_BASE = BACKEND_ORIGIN + "/media/thumbnails/video/";

  const container = document.getElementById('container');
  const lightbox = document.getElementById('lightbox');
  const lightboxInner = document.getElementById('lightboxInner');
  const lbClose = document.getElementById('lbClose');
  const offlineBanner = document.getElementById('offlineBanner');
  const passwordOverlay = document.getElementById('passwordOverlay');
  const pwInput = document.getElementById('pwInput');
  const pwBtn = document.getElementById('pwBtn');
  const pwMsg = document.getElementById('pwMsg');

  function saveToken(token, expires_at) {
    sessionStorage.setItem('media_token', token);
    sessionStorage.setItem('media_token_exp', String(expires_at || (Date.now()/1000 + 3600)));
  }
  function getToken() {
    const tk = sessionStorage.getItem('media_token');
    const exp = Number(sessionStorage.getItem('media_token_exp') || 0);
    if (!tk || Date.now()/1000 > exp) {
      sessionStorage.removeItem('media_token');
      sessionStorage.removeItem('media_token_exp');
      return null;
    }
    return tk;
  }
  function clearToken(){
    sessionStorage.removeItem('media_token');
    sessionStorage.removeItem('media_token_exp');
  }

  async function checkBackend() {
    try {
      const res = await fetch(HEALTH_URL, {cache: "no-store"});
      if (!res.ok) throw new Error("bad");
      offlineBanner.style.display = "none";
      return true;
    } catch (err) {
      offlineBanner.style.display = "block";
      return false;
    }
  }

  async function authenticate(password) {
    try {
      const res = await fetch(AUTH_URL, {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({password})
      });
      if (!res.ok) {
        if (res.status === 403) throw new Error("wrong");
        throw new Error("auth-failed");
      }
      const j = await res.json();
      if (!j.token) throw new Error("no-token");
      saveToken(j.token, j.expires_at || (Date.now()/1000 + 3600));
      return true;
    } catch (err) {
      if (err.message === "wrong") pwMsg.textContent = "Wrong password";
      else pwMsg.textContent = "Auth failed";
      pwMsg.style.display = "block";
      return false;
    }
  }

  async function fetchMediaList(token) {
    const res = await fetch(MEDIA_LIST_URL, {
      headers: { "Authorization": "Bearer " + token }
    });
    if (!res.ok) {
      if (res.status === 403) throw new Error("forbidden");
      throw new Error("list-failed");
    }
    return res.json();
  }

  // Generic fetch for blob with token
  async function fetchBlobWithToken(url, token) {
    const res = await fetch(url, {
      headers: { "Authorization": "Bearer " + token }
    });
    if (!res.ok) throw new Error("fetch-failed");
    const blob = await res.blob();
    return URL.createObjectURL(blob);
  }

  let mediaItems = []; 

  function makePlaceholderCard(item, index) {
    const a = document.createElement('a');
    a.className = "media-card";
    a.href = "#";
    a.dataset.index = index;
    a.dataset.name = item.name;
    const ph = document.createElement('div');
    ph.className = "placeholder";
    ph.textContent = item.type === "video" ? "Video" : "Loading...";
    a.appendChild(ph);
    a.addEventListener('click', (ev) => {
      ev.preventDefault();
      openLightbox(index);
    });
    container.appendChild(a);
    return a;
  }

  // Lazy loader
  async function loadBlobForIndex(index) {
    const token = getToken();
    if (!token) return; 
    const item = mediaItems[index];
    if (!item || item.loaded) return;

    try {
      let urlToFetch = "";
      
      // LOGIC: 
      // 1. If Video -> Fetch Thumbnail (name.jpg) from special thumbnail endpoint
      // 2. If Image -> Fetch Original Image from standard endpoint
      
      if (item.type === "video") {
        // Assume thumbnail is named "1.jpg" for video "1.mp4"
        // remove extension from video name and add .jpg
        const thumbName = item.name.replace(/\.[^/.]+$/, "") + ".jpg";
        urlToFetch = V_THUMB_URL_BASE + encodeURIComponent(thumbName);
      } else {
        urlToFetch = MEDIA_URL_BASE + encodeURIComponent(item.name);
      }

      const blobUrl = await fetchBlobWithToken(urlToFetch, token);
      
      const el = item.el;
      el.innerHTML = ""; // clear placeholder

      const img = document.createElement('img');
      img.src = blobUrl;
      img.alt = item.name;
      img.loading = "lazy";
      el.appendChild(img);

      // Add play button overlay for videos
      if (item.type === "video") {
        const overlay = document.createElement('div');
        overlay.className = "video-overlay";
        overlay.innerHTML = '<div class="play-icon">▶</div>';
        el.appendChild(overlay);
        // We do NOT set item.blobUrl here because this is just the thumbnail blob
      } else {
        // For images, the grid image IS the full image (since you don't have image thumbs)
        item.blobUrl = blobUrl;
      }
      
      item.loaded = true;

    } catch (err) {
      console.warn("failed to fetch media/thumb:", item.name, err);
      if (!(await checkBackend())) {}
    }
  }

  const io = new IntersectionObserver((entries) => {
    for (const e of entries) {
      if (e.isIntersecting) {
        const idx = Number(e.target.dataset.index);
        loadBlobForIndex(idx);
        io.unobserve(e.target);
      }
    }
  }, {rootMargin: "500px 0px"});

  async function buildGallery(list) {
    container.innerHTML = "";
    mediaItems = [];
    list.forEach((it, idx) => {
      const el = makePlaceholderCard(it, idx);
      mediaItems.push({name: it.name, type: it.type, el, loaded: false});
      io.observe(el);
    });
  }

  // Lightbox
  let currentIndex = -1;
  async function openLightbox(index) {
    if (index < 0 || index >= mediaItems.length) return;
    currentIndex = index;
    const item = mediaItems[index];
    lightboxInner.innerHTML = "";
    
    lightbox.classList.add('active');
    lightbox.setAttribute('aria-hidden','false');

    // If we don't have the main content blob yet
    // (For videos, we never have it until now. For images, we usually have it unless lazy load failed)
    if (!item.blobUrl) {
      lightboxInner.innerHTML = `<div class="loader"></div><div style="color:#ccc">Loading...</div>`;
      try {
        const token = getToken();
        if (!token) throw new Error("no-token");
        const url = MEDIA_URL_BASE + encodeURIComponent(item.name);
        item.blobUrl = await fetchBlobWithToken(url, token);
      } catch (err) {
        lightboxInner.innerHTML = "<div style='color:#f88'>Unable to load media.</div>";
        return;
      }
    }

    lightboxInner.innerHTML = "";

    if (item.type === "image") {
      const img = document.createElement('img');
      img.src = item.blobUrl;
      img.alt = item.name;
      lightboxInner.appendChild(img);
    } else {
      const vid = document.createElement('video');
      vid.src = item.blobUrl;
      vid.controls = true;
      vid.autoplay = true;
      vid.playsInline = true;
      lightboxInner.appendChild(vid);
      // Give DOM time to insert before playing
      setTimeout(()=>{ vid.play().catch(()=>{}); }, 50);
    }
  }

  function closeLightbox() {
    lightbox.classList.remove('active');
    lightbox.setAttribute('aria-hidden','true');
    const v = lightboxInner.querySelector('video');
    if (v) { v.pause(); v.currentTime = 0; }
    lightboxInner.innerHTML = '';
  }

  lbClose.addEventListener('click', closeLightbox);
  window.addEventListener('keydown', (ev) => {
    if (!lightbox.classList.contains('active')) return;
    if (ev.key === 'Escape') closeLightbox();
    else if (ev.key === 'ArrowLeft') { ev.preventDefault(); if (currentIndex > 0) openLightbox(currentIndex-1); }
    else if (ev.key === 'ArrowRight') { ev.preventDefault(); if (currentIndex < mediaItems.length - 1) openLightbox(currentIndex+1); }
  });
  lightbox.addEventListener('click', (ev) => { if (ev.target === lightbox) closeLightbox(); });

  pwBtn.addEventListener('click', async () => {
    pwMsg.style.display = "none";
    pwBtn.disabled = true;
    const pw = pwInput.value || "";
    const ok = await authenticate(pw);
    pwBtn.disabled = false;
    if (ok) {
      passwordOverlay.style.display = "none";
      await loadAfterAuth();
    } else {
      pwInput.value = "";
    }
  });
  pwInput.addEventListener('keydown', (e) => { if (e.key === 'Enter') pwBtn.click(); });

  async function loadAfterAuth() {
    const token = getToken();
    if (!token) { passwordOverlay.style.display = "flex"; return; }
    try {
      const list = await fetchMediaList(token);
      await buildGallery(list);
    } catch (err) {
      console.error("unable to load list", err);
      if (err.message === "forbidden") {
        clearToken();
        passwordOverlay.style.display = "flex";
      } else {
        await checkBackend();
      }
    }
  }

  (async function init(){
    const backendUp = await checkBackend();
    const token = getToken();
    if (!backendUp) {
      passwordOverlay.style.display = "none";
      container.innerHTML = "<div style='color:#999;padding:20px;text-align:center'>Backend offline.</div>";
      return;
    }
    if (token) {
      await loadAfterAuth();
    } else {
      passwordOverlay.style.display = "flex";
      pwInput.focus();
    }
  })();
  </script>
</body>
</html>
